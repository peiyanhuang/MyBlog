---
layout: post
title:  Webpack 记录
date:   2016-10-07 13:58:00 +0800
categories: 前端工具
tag: 前端工具
---

* content
{:toc}

### 1. Error: Cannot resolve 'file' or 'directory'

错误原因：获取的文件没有后缀名

必须要检查 `webpack` 的 `resolve` 配置信息，如果没有配置 `resolve`，必须添加在 `webpack` 配置文件中如下信息：

```js
//  用来配置应用层的模块解析，即要被打包的模块
resolve: {
  //  第一项扩展非常重要，千万不要忽略，否则经常出现模块无法加载错误
  extensions: ['', '.js', '.es6', '.vue','.css']
},
```

通过以上配置，webpack会自动为请求的文件添加后缀名，从而保证请求的路径正确无误。

对上面的配置进行说明，即请求js、es6、vue文件时不需要添加后缀名，直接请求即可，如下。

```js
import {add} from './MathUtils'
```

### 2. loader for CSS、Style、SASS

webpack提供两个工具处理样式表，`css-loader` 和 `style-loader`，二者处理的任务不同，css-loader 使你能够使用类似 `@import` 和 `url(...)` 的方法实现 `require()` 的功能， `style-loader` 将所有的计算后的样式加入页面中，二者组合在一起使你能够把样式表嵌入 webpack 打包后的JS文件中。

具体处理流程如下：

1. 通过 `sass-loader` 把 SCSS 源码转换为 CSS 代码，再把 CSS 代码交给 `css-loader` 去处理。
2. `css-loader` 会找出 CSS 代码中的 `@import` 和 `url()` 这样的导入语句，告诉 Webpack 依赖这些资源。同时还支持 CSS Modules、压缩 CSS 等功能。处理完后再把结果交给 `style-loader` 去处理。
3. `style-loader` 会把 CSS 代码转换成字符串后，注入到 JavaScript 代码中去，通过 JavaScript 去给 DOM 增加样式。如果你想把 CSS 代码提取到一个单独的文件而不是和 JavaScript 混在一起，可以使用 Plugin 中介绍过的 `ExtractTextPlugin`。

### 3. 支持 browserHistory

1. `webpack-dev-server`: 设置 `historyApiFallback: true`。

2. `webpack-dev-middleware`: 如下设置

```js
// browserHistory
app.use("*", (req, res, next) => {
	const filename = path.resolve(compiler.outputPath, "index.html");
	compiler.outputFileSystem.readFile(filename, (err, result) => {
		if (err) {
				return next(err);
		}
		res.set("content-type", "text/html");
		res.send(result);
		res.end();
	});
});
```

注意：这要放在 `webpack-dev-middleware` 和 `webpack-hot-middleware` 中间件之后。

由于 `webpack-dev-middleware` 只是将文件打包在内存里，所以你没法在 `express` 里直接 `sendFile(dist/index.html')`，因为这个文件实际上还不存在。还好 `webpack` 提供了一个 `outputFileStream`，用来输出其内存里的文件，我们可以利用它来做路由。

3. `connect-history-api-fallback`：

```js
// BrowserRouter
app.use('/', require('connect-history-api-fallback')());
app.use('/', express.static('../src'));  // 开发的 index.html 目录
```

注意：这要放在 `webpack-dev-middleware` 和 `webpack-hot-middleware` 中间件之前。

### 4. 打包速度优化

#### 4.1 缩小文件搜索范围

Webpack 启动后会从配置的 Entry 出发，解析出文件中的导入语句，再递归的解析。 在遇到导入语句时 Webpack 会做两件事情：

1. 根据导入语句去寻找对应的要导入的文件。例如 `import React from 'react'` 导入语句对应的文件是 `./node_modules/react/react.js`;
2. 根据找到的要导入文件的后缀，使用配置中的 `Loader` 去处理文件。例如使用 ES6 开发的 JavaScript 文件需要使用 `babel-loader` 去处理。

以上两件事情虽然对于处理一个文件非常快，但是当项目大了以后文件量会变的非常多，这时候构建速度慢的问题就会暴露出来。虽然以上两件事情无法避免，但需要尽量减少以上两件事情的发生，以提高速度。

* 优化 loader 配置: 在使用 Loader 时可以通过 `test、include、exclude` 三个配置项来命中 Loader 要应用规则的文件。 为了尽可能少的让文件被 Loader 处理，可以通过 `include` 去命中只有哪些文件需要被处理。
  
* 优化 `resolve.modules` 配置: `resolve.modules` 用于配置 Webpack 去哪些目录下寻找第三方模块。它的默认值是 `['node_modules']`，含义是先去当前目录下的 `./node_modules` 目录下去找想找的模块，如果没找到就去上一级目录 `../node_modules` 中找，再没有就去 `../../node_modules` 中找，以此类推，这和 Node.js 的模块寻找机制很相似。当安装的第三方模块都放在项目根目录下的 `./node_modules` 目录下时，没有必要按照默认的方式去一层层的寻找，可以指明存放第三方模块的绝对路径，以减少寻找，配置如下：

```js
module.exports = {
  resolve: {
    // 使用绝对路径指明第三方模块存放的位置，以减少搜索步骤
    modules: [path.resolve(__dirname, 'node_modules')]
  },
};
```

* 优化 `resolve.mainFields` 配置: 安装的第三方模块中都会有一个 `package.json` 文件用于描述这个模块的属性，其中有些字段用于描述入口文件在哪里，`resolve.mainFields` 用于配置采用哪个字段作为入口文件的描述。

`resolve.mainFields` 的默认值和当前的 target 配置有关系，对应关系如下：

- 当 `target` 为 `web` 或者 `webworker` 时，值是 `["browser", "module", "main"]`
- 当 `target` 为其它情况时，值是 `["module", "main"]`

为了减少搜索步骤，在明确第三方模块的入口文件描述字段时，可以把它设置的尽量少。 由于大多数第三方模块都采用 `main` 字段去描述入口文件的位置，可以这样配置 Webpack：

```js
module.exports = {
  resolve: {
    // 只采用 main 字段作为入口文件描述字段，以减少搜索步骤
    mainFields: ['main'],
  },
};
```

***注意：***使用本方法优化时，需要考虑到所有运行时依赖的第三方模块的入口文件描述字段，就算有一个模块搞错了都可能会造成构建出的代码无法正常运行。

* 优化 `resolve.extensions` 配置: 在导入语句没带文件后缀时，Webpack 会自动带上后缀后去尝试询问文件是否存在。

- 后缀尝试列表要尽可能的小，不要把项目中不可能存在的情况写到后缀尝试列表中；
- 频率出现最高的文件后缀要优先放在最前面，以做到尽快的退出寻找过程；
- 在源码中写导入语句时，要尽可能的带上后缀，从而可以避免寻找过程。

#### 4.2 使用 DllPlugin

包含大量复用模块的动态链接库只需要编译一次，在之后的构建过程中被动态链接库包含的模块将不会在重新编译，而是直接使用动态链接库中的代码。由于动态链接库中大多数包含的是常用的第三方模块，例如 react、react-dom，只要不升级这些模块的版本，动态链接库就不用重新编译。

#### 4.3 多进程构建

1. [HappyPack](https://github.com/amireh/happypack#how-it-works)
2. [thread-loader](https://github.com/webpack-contrib/thread-loader)

#### 4.4 打包分析

1. [体积分析 webpack-bundle-analyzer](https://github.com/webpack-contrib/webpack-bundle-analyzer)
2. [耗时分析 speed-measure-webpack-plugin](https://github.com/stephencookdev/speed-measure-webpack-plugin)